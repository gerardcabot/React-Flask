name: Keep Render API Alive

on:
  schedule:
    # Executa cada 3 hores (Aproximadament 240 pings/mes)
    # Aquesta freq√º√®ncia √©s necess√†ria per mantenir-se sota el l√≠mit de 300 peticions/mes de Render.
    - cron: '0 */3 * * *'
  workflow_dispatch:  # Permet execuci√≥ manual des de GitHub

jobs:
  ping-api:
    runs-on: ubuntu-latest
    
    steps:
      - name: Ping Health Endpoint with Retry Logic
        run: |
          echo "üèì Pinging API at $(date)"
          echo "================================================"
          
          MAX_RETRIES=5
          RETRY_DELAY=30
          TIMEOUT=120
          SUCCESS=0
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo ""
            echo "üîÑ Attempt $i of $MAX_RETRIES..."
            
            # Perform the request
            response=$(curl -s -w "\n%{http_code}" \
              --max-time $TIMEOUT \
              --connect-timeout 30 \
              https://football-api-r0f2.onrender.com/health 2>&1)
            
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | head -n-1)
            
            echo "Response Code: $http_code"
            
            # Check if we got a 200 response
            if [ "$http_code" = "200" ]; then
              echo "Response Body: $body"
              
              # Verify the response contains "healthy"
              if echo "$body" | grep -q "healthy"; then
                echo "‚úÖ API is healthy!"
                echo "‚úÖ Response contains 'healthy' keyword"
                SUCCESS=1
                break
              else
                echo "‚ö†Ô∏è Response doesn't contain 'healthy' keyword"
                echo "Body received: $body"
              fi
            else
              echo "‚ö†Ô∏è API returned status code: $http_code"
              
              # If it's a cold start, Render might return 503 or timeout
              if [ $i -lt $MAX_RETRIES ]; then
                echo "üí§ API might be in cold start..."
                echo "‚è≥ Waiting ${RETRY_DELAY}s before retry..."
                sleep $RETRY_DELAY
              fi
            fi
          done
          
          echo ""
          echo "================================================"
          
          if [ $SUCCESS -eq 1 ]; then
            echo "‚úÖ Keep-alive ping completed successfully"
            # Actualitzaci√≥ del missatge
            echo "‚è∞ Next ping will occur in ~3 hours"
            echo "üìä This keeps your Render API from spinning down periodically"
            echo "================================================"
            exit 0
          else
            echo "‚ùå Failed to ping API after $MAX_RETRIES attempts"
            echo "üîç This might indicate a real problem with your API"
            echo "üìù Check Render logs for more details"
            echo "================================================"
            exit 1
          fi